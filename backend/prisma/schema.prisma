generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String   @id @default(uuid())
  email                   String   @unique
  password                String   // Hash bcrypt
  companyName             String
  createdAt               DateTime @default(now())

  companies               Company[]
}

model Company {
  id                      String   @id @default(uuid())
  name                    String
  sector                  String
  size                    String
  location                String
  contact                 String
  email                   String   @unique
  isActive                Boolean  @default(true)
  userId                  String?  @unique
  user                    User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  scores                  Score[]
  assignments             CompanyAssignment[]
  activityLogs            ActivityLog[]
  actionPlans             CompanyActionPlan[]
  chatbotMetrics          ChatbotMetrics[]
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  // Logistique et Centres
  tonnageLogistique       Float?
  emissionsLogistiques    Float?
  tonnageAlternatif       Float?
  coutActuel              Float?
  coutTraitement          Float?
  centreActuel            Float?
  centreAlternatif        Float?

  // Consommations énergétiques
  electriciteKWh          Float?
  gazKWh                  Float?
  eauM3                   Float?
  carburantsLitres        Float?
  consommationEau         Float?
  consommationCarburant   Float?

  // Émissions
  emissionsScope12        Float?

  // Indicateurs sociaux
  heuresFormation         Float?
  partAchatsLocaux        Float?
  partEmploisLocaux       Float?

  // Gestion des déchets
  dechetsTotaux           Float?
  dechetsValorises        Float?
  pourcentageValorisation Float?
  dechetsDangereux        Float?

  // Indicateurs économiques avancés
  depensesMaintenanceMad  Float?
  dureeVieEquipementAns   Float?
  tauxRebutPct            Float?
  beneficeEconomique      Float?
  coutAlternatifMad       Float?
  economiePotentielleMad  Float?
  tauxUtilisationEqPct    Float?
  matieresRecycleesMad    Float?

  // Indicateurs sociaux avancés
  achatsResponsablesPct   Float?
  partEmploisLocauxPct    Float?
  recrutementAn           Float?
  heuresFormationSalarieAn Float?
  partFemmesPct           Float?
}

model Score {
  id                 String   @id @default(uuid())
  companyId          String
  company            Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  governanceScore    Float
  economicScore      Float
  socialScore        Float
  environmentalScore Float
  overallScore       Float
  maturityLevel      String
  responses          Json
  actionPlan         ActionPlan?
  actionPlans        CompanyActionPlan[]
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([companyId])
  @@index([maturityLevel])
}

model ActionPlan {
  id              String   @id @default(uuid())
  scoreId         String   @unique
  recommendations String
  priority        String
  timeline        String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model SectorAverage {
  id        String @id @default(uuid())
  sector    String @unique
  avgScore  Float
}

model AdminUser {
  id            String         @id @default(uuid())
  email         String         @unique
  password      String
  firstName     String
  lastName      String
  role          AdminRole      @default(EXPERT)
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  assignedCompanies CompanyAssignment[]
  activityLogs  ActivityLog[]
}

enum AdminRole {
  SUPER_ADMIN
  EXPERT
  VIEWER
}

model CompanyAssignment {
  id          String    @id @default(uuid())
  companyId   String
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  adminUserId String
  adminUser   AdminUser @relation(fields: [adminUserId], references: [id], onDelete: Cascade)
  assignedAt  DateTime  @default(now())

  @@unique([companyId, adminUserId])
}

model ActivityLog {
  id          String    @id @default(uuid())
  adminUserId String?
  adminUser   AdminUser? @relation(fields: [adminUserId], references: [id], onDelete: SetNull)
  companyId   String?
  company     Company?  @relation(fields: [companyId], references: [id], onDelete: SetNull)
  action      String
  entityType  String
  entityId    String?
  details     String?
  ipAddress   String?
  createdAt   DateTime  @default(now())

  @@index([adminUserId])
  @@index([companyId])
  @@index([createdAt])
}

model ActionPlanTemplate {
  id          String   @id @default(uuid())
  category    String
  maturityLevel String
  title       String
  description String
  priority    String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model CompanyActionPlan {
  id          String   @id @default(uuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  scoreId     String
  score       Score    @relation(fields: [scoreId], references: [id], onDelete: Cascade)
  actions     String   // JSON des actions
  status      ActionPlanStatus @default(PENDING)
  adminNotes  String?
  validatedAt DateTime?
  validatedBy String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([companyId])
  @@index([status])
}

enum ActionPlanStatus {
  PENDING
  IN_REVIEW
  APPROVED
  REJECTED
  IN_PROGRESS
  COMPLETED
}

model ChatbotMetrics {
  id              String   @id @default(uuid())
  question        String
  responseTime    Int
  confidence      Float
  wasHelpful      Boolean?
  source          String
  companyId       String?
  company         Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)
  createdAt       DateTime @default(now())

  @@index([createdAt])
  @@index([confidence])
}

model QuestionnaireQuestion {
  id           String   @id @default(uuid())
  questionId   String   @unique
  sector       String
  category     String
  text         String
  type         String
  weight       Float
  unit         String?
  choices      String?
  isoReference String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model ChatbotDocument {
  id          String    @id @default(uuid())
  filename    String
  fileType    String
  filePath    String
  fileSize    Int
  title       String
  description String?
  content     String
  isActive    Boolean   @default(true)
  uploadedBy  String
  uploadedAt  DateTime  @default(now())
  wordCount   Int?
  language    String?
  usageCount  Int       @default(0)
  lastUsed    DateTime?

  chunks      DocumentChunk[]
}

model DocumentChunk {
  id            String           @id @default(uuid())
  documentId    String
  document      ChatbotDocument  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  chunkIndex    Int
  content       String
  embedding     String
  createdAt     DateTime         @default(now())

  @@index([documentId])
}

model DemoMode {
  id        String   @id @default(uuid())
  isActive  Boolean  @default(false)
  updatedAt DateTime @updatedAt
}